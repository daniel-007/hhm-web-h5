!function(){function e(e,r,t){$.ajax({type:"POST",url:e,data:r,timeout:15e3,success:function(e,r,o){e.status?t(null,e):t(e.msg,null)},error:function(r,o,i){console.error(e+" error: "+o+"##"+i),t("服务异常",null)}})}require.config({baseUrl:"../js",paths:{Vue:"./lib/vue.min",Utils:"./lib/utils"},shim:{Vue:{exports:"Vue"},Utils:{exports:"Utils"}}}),require(["Vue","Utils"],function(r,t){"use strict";r.config.delimiters=["${","}"],r.config.unsafeDelimiters=["{!!","!!}"],$(document).on("pageInit","#page-book-confirm",function(o,i,a){var c=t.getSearch(location),s=0;c.id&&(s=parseInt(c.id));var n=new r({el:"#page-book-confirm",data:{payment:0,receiver:null,cartsAry:[],countPrice:0,cartIds:[]}});e("/address/get-all-receiver",{},function(e,r){if(e)$.toast(e,1e3);else{var t=r.receiver,o=t.length,i=0;if(s>0){for(i=0;o>i;i++)if(t[i].SysNo===s){n.receiver={},n.receiver.receiverId=t[i].SysNo,n.receiver.phone=t[i].ReceiverPhone,n.receiver.receiver=t[i].ReceiverName,n.receiver.pcdDes=t[i].Province+" "+t[i].City+" "+t[i].District,n.receiver.address=t[i].Address;break}}else for(i=0;o>i;i++)if(t[i].IsDefault){n.receiver={},n.receiver.receiverId=t[i].SysNo,n.receiver.phone=t[i].ReceiverPhone,n.receiver.receiver=t[i].ReceiverName,n.receiver.pcdDes=t[i].Province+" "+t[i].City+" "+t[i].District,n.receiver.address=t[i].Address;break}null===n.receiver&&o>0&&(n.receiver={},n.receiver.receiverId=t[0].SysNo,n.receiver.phone=t[0].ReceiverPhone,n.receiver.receiver=t[0].ReceiverName,n.receiver.pcdDes=t[0].Province+" "+t[0].City+" "+t[0].District,n.receiver.address=t[0].Address)}}),e("/cart/cart-info",{},function(e,r){if(e)$.toast(e,1e3);else{for(var t=r.cart,o=t.length,i=null,a={},c=0;o>c;c++){i=t[c];var s={};void 0===a[i.ProductSysNo]?(a[i.ProductSysNo]={},a[i.ProductSysNo].name=i.Name,a[i.ProductSysNo].productId=i.ProductSysNo,a[i.ProductSysNo].image=i.Images.length>0?i.Images[0].ImgUrl:"",a[i.ProductSysNo].skus=[],a[i.ProductSysNo].checked=!0,a[i.ProductSysNo].stock=i.Stock,s.cartId=i.SysId,s.skuId=i.SkuSysNo,s.size=i.SizeName,s.qty=i.Qty,s.price=i.Price,n.countPrice+=s.price*s.qty,a[i.ProductSysNo].skus.push(s),n.cartIds.push(s.cartId)):(s.cartId=i.SysId,s.skuId=i.SkuSysNo,s.size=i.SizeName,s.qty=i.Qty,s.price=i.Price,n.countPrice+=s.price*s.qty,a[i.ProductSysNo].skus.push(s),n.cartIds.push(s.cartId))}for(var d in a)a.hasOwnProperty(d)&&n.cartsAry.push(a[d])}}),$(a).on("click","#submitBook",function(r){r.preventDefault(),e("/book/confirm",{receiverId:n.receiver.receiverId,logistics:"快递",payment:n.payment,cartIds:JSON.stringify(n.cartIds)},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{if(0===n.payment)return location.href="/weixin/oauth?orderId="+r.orderId+"&name="+n.receiver.receiver,void $.showPreloader("准备支付...");if(4===n.payment)return void(location.href="/book/complete")}}),$.showPreloader("提交订单...")})}),$(document).on("pageInit","#page-book-complete",function(e,t,o){new r({el:"#page-book-complete",data:{}})}),$(document).on("pageInit","#page-book-pay-way",function(o,i,a){function c(){e("/book/detail",{orderId:l},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var t=r.order;p.amount=100*t.Amount,p.isReady=!0}})}function s(e){WeixinJSBridge.invoke("getBrandWCPayRequest",e,function(e){"get_brand_wcpay_request:ok"==e.err_msg?location.href="/book/complete":($.toast("支付失败, 请到我的订单重新支付！",1e3),setTimeout(function(){location.href="/users/my-book"},1e3))})}function n(){e("/weixin/pay",{openId:u,orderId:l,amount:p.amount,userName:v},function(e,r){$.hidePreloader(),e?$.toast(e,1e3):s(r.payargs)})}var d=t.getSearch(location),u=0,l=0,v="";d.openId&&d.state||(location.href="/"),u=d.openId;var y=d.state;y=y.split("@"),l=parseInt(y[0]),v=y[1];var p=new r({el:"#page-book-pay-way",data:{amount:0,isReady:!1},methods:{pay:n}});c(),$.showPreloader("请稍等...")}),$(document).on("pageInit","#page-book-detail",function(o,i,a){var c=t.getSearch(location);if(!c.id)return void(location.href="/");var s=parseInt(c.id),n=new r({el:"#page-book-detail",data:{orderId:s,order:{}}});e("/book/detail",{orderId:n.orderId},function(e,r){if($hidePreloader(),e)$.toast(e,1e3);else{var o=r.order;o.statusNote="",o.canCancel=!1,o.canPay=!1,o.reBuy=!1,"待审核"===o.Status||"待付款"===o.Status?"货到付款"===!o.PayMent&&"UnPay"===o.PayStatus?(o.statusNote="待付款",o.canCancel=!0,o.canPay=!0):(o.statusNote="待审核",o.canCancel=!0):"待发货"===o.Status||"已发货"===o.Status?o.statusNote=o.Status:(o.statusNote=o.Status,o.reBuy=!0),n.order=t.clone(o)}}),$.showPreloader("请稍等")}),$.init()})}();