!function(){function e(e,r,o){$.ajax({type:"POST",url:e,data:r,timeout:15e3,success:function(e,r,t){e.status?o(null,e):o(e.msg,null)},error:function(r,t,i){console.error(e+" error: "+t+"##"+i),o("服务异常",null)}})}require.config({baseUrl:"../js",paths:{Vue:"./lib/vue.min",Utils:"./lib/utils"},shim:{Vue:{exports:"Vue"},Utils:{exports:"Utils"}}}),require(["Vue","Utils"],function(r,o){"use strict";r.config.delimiters=["${","}"],r.config.unsafeDelimiters=["{!!","!!}"],$(document).on("pageInit","#page-book-confirm",function(t,i,a){var c=o.getSearch(location),n=0,s=[];c.id&&(n=parseInt(c.id)),c.product&&(s=c.product.split("!"));var d=new r({el:"#page-book-confirm",data:{payment:0,receiver:null,cartsAry:[],countPrice:0,cartIds:[],productIdStr:c.product}});e("/address/get-all-receiver",{},function(e,r){if(e)$.toast(e,1e3);else{var o=r.receiver,t=o.length,i=0;if(d.receiver={receiverId:0,phone:"",receiver:"",pcdDes:"",address:""},n>0){for(i=0;t>i;i++)if(o[i].SysNo===n){d.receiver.receiverId=o[i].SysNo,d.receiver.phone=o[i].ReceiverMobile,d.receiver.receiver=o[i].ReceiverName,d.receiver.pcdDes=o[i].Province+" "+o[i].City+" "+o[i].District,d.receiver.address=o[i].Address;break}}else for(i=0;t>i;i++)if(o[i].IsDefault){d.receiver.receiverId=o[i].SysNo,d.receiver.phone=o[i].ReceiverMobile,d.receiver.receiver=o[i].ReceiverName,d.receiver.pcdDes=o[i].Province+" "+o[i].City+" "+o[i].District,d.receiver.address=o[i].Address;break}null===d.receiver&&t>0&&(d.receiver.receiverId=o[0].SysNo,d.receiver.phone=o[0].ReceiverMobile,d.receiver.receiver=o[0].ReceiverName,d.receiver.pcdDes=o[0].Province+" "+o[0].City+" "+o[0].District,d.receiver.address=o[0].Address)}}),e("/cart/cart-info",{},function(e,r){if(e)$.toast(e,1e3);else{for(var o=r.cart,t=o.length,i=null,a={},c=0;t>c;c++)if(i=o[c],-1!==s.indexOf(i.ProductSysNo+"")){var n={};void 0===a[i.ProductSysNo]?(a[i.ProductSysNo]={},a[i.ProductSysNo].name=i.Name,a[i.ProductSysNo].productId=i.ProductSysNo,a[i.ProductSysNo].image=i.Images.length>0?i.Images[0].ImgUrl:"",a[i.ProductSysNo].skus=[],a[i.ProductSysNo].checked=!0,a[i.ProductSysNo].stock=i.Stock,n.cartId=i.SysId,n.skuId=i.SkuSysNo,n.size=i.SizeName,n.qty=i.Qty,n.price=i.Price,d.countPrice+=n.price*n.qty,a[i.ProductSysNo].skus.push(n),d.cartIds.push(n.cartId)):(n.cartId=i.SysId,n.skuId=i.SkuSysNo,n.size=i.SizeName,n.qty=i.Qty,n.price=i.Price,d.countPrice+=n.price*n.qty,a[i.ProductSysNo].skus.push(n),d.cartIds.push(n.cartId))}for(var u in a)a.hasOwnProperty(u)&&d.cartsAry.push(a[u])}}),$(a).on("click","#submitBook",function(r){r.preventDefault(),e("/book/confirm",{receiverId:d.receiver.receiverId,logistics:"快递",payment:d.payment,cartIds:JSON.stringify(d.cartIds)},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{if(0===d.payment)return location.href="/weixin/oauth?orderId="+r.orderId+"&name="+d.receiver.receiver,void $.showPreloader("准备支付...");if(4===d.payment)return void(location.href="/book/complete")}}),$.showPreloader("提交订单...")})}),$(document).on("pageInit","#page-book-complete",function(e,o,t){new r({el:"#page-book-complete",data:{}})}),$(document).on("pageInit","#page-book-pay-way",function(t,i,a){function c(){e("/book/detail",{orderId:l},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var o=r.order;v.amount=100*o.Amount,v.isReady=!0}})}function n(e){WeixinJSBridge.invoke("getBrandWCPayRequest",e,function(e){"get_brand_wcpay_request:ok"==e.err_msg?location.href="/book/complete":($.toast("支付失败, 请到我的订单重新支付！",1e3),setTimeout(function(){location.href="/users/my-book"},1e3))})}function s(){e("/weixin/pay",{openId:u,orderId:l,amount:v.amount,userName:p},function(e,r){$.hidePreloader(),e?$.toast(e,1e3):n(r.payargs)})}var d=o.getSearch(location),u=0,l=0,p="";d.openId&&d.state||(location.href="/"),u=d.openId;var f=d.state;f=f.split("@"),l=parseInt(f[0]),p=f[1];var v=new r({el:"#page-book-pay-way",data:{amount:0,isReady:!1},methods:{pay:s}});c(),$.showPreloader("请稍等...")}),$(document).on("pageInit","#page-book-detail",function(t,i,a){function c(){location.href="/weixin/oauth?orderId="+u+"&name="+l.order.ReceiverName,$.showPreloader("准备支付...")}function n(){$.confirm("确定删除该商品吗?",function(){e("/book/cancel",{orderId:l.orderId},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var o=l.order;o.Status="已取消",o.statusNote="已取消",o.canCancel=!1,o.canPay=!1,o.reBuy=!0}}),$.showPreloader("取消订单")},function(){})}function s(){}var d=o.getSearch(location);if(!d.id)return void(location.href="/");var u=parseInt(d.id),l=new r({el:"#page-book-detail",data:{orderId:u,order:{}},methods:{payOrder:c,cancelOrder:n,reBuy:s}});e("/book/detail",{orderId:l.orderId},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var t=r.order;t.statusNote="",t.canCancel=!1,t.canPay=!1,t.reBuy=!1,t.PCD=t.PCD.replace(/\-/g," "),"待审核"===t.Status||"待付款"===t.Status?"货到付款"===!t.PayMent&&"UnPay"===t.PayStatus?(t.statusNote="待付款",t.canCancel=!0,t.canPay=!0):(t.statusNote="待审核",t.canCancel=!0):"待发货"===t.Status||"已发货"===t.Status?t.statusNote=t.Status:(t.statusNote=t.Status,t.reBuy=!0),l.order=o.clone(t)}}),$.showPreloader("请稍等")}),$.init()})}();