!function(){function e(e,r,o){$.ajax({type:"POST",url:e,data:r,timeout:15e3,success:function(e,r,t){e.status?o(null,e):o(e.msg,null)},error:function(r,t,i){console.error(e+" error: "+t+"##"+i),o("服务异常",null)}})}require.config({baseUrl:"../js",paths:{Vue:"./lib/vue.min",Utils:"./lib/utils.min"},shim:{Vue:{exports:"Vue"},Utils:{exports:"Utils"}}}),require(["Vue","Utils"],function(r,o){"use strict";r.config.delimiters=["${","}"],r.config.unsafeDelimiters=["{!!","!!}"],$(document).on("pageInit","#page-book-confirm",function(t,i,a){function c(){u.receiverCount>0?location.href="/address?id="+u.receiver.receiverId+"&product="+u.productIdStr:location.href="/address/add?type=1&product="+u.productIdStr}var n=o.getSearch(location),s=0,d=[];n.id&&(s=parseInt(n.id)),n.product&&(d=n.product.split("!"));var u=new r({el:"#page-book-confirm",data:{payment:0,receiver:null,cartsAry:[],countPrice:0,cartIds:[],productIdStr:n.product,promotion:0,receiverCount:0},methods:{selectAddress:c},computed:{actualPrice:function(){var e=(100*this.countPrice-100*this.promotion)/100;return e>0?e.toFixed(2):0}}});e("/address/get-all-receiver",{},function(e,r){if(e)$.toast(e,1e3);else{var o=r.receiver,t=o.length;u.receiverCount=t;var i=0;if(u.receiver={receiverId:0,phone:"",receiver:"",pcdDes:"",address:""},s>0){for(i=0;t>i;i++)if(o[i].SysNo===s){u.receiver.receiverId=o[i].SysNo,u.receiver.phone=o[i].ReceiverMobile,u.receiver.receiver=o[i].ReceiverName,u.receiver.pcdDes=o[i].Province+" "+o[i].City+" "+o[i].District+" "+o[i].Street,u.receiver.address=o[i].Address;break}}else for(i=0;t>i;i++)if(o[i].IsDefault){u.receiver.receiverId=o[i].SysNo,u.receiver.phone=o[i].ReceiverMobile,u.receiver.receiver=o[i].ReceiverName,u.receiver.pcdDes=o[i].Province+" "+o[i].City+" "+o[i].District+" "+o[i].Street,u.receiver.address=o[i].Address;break}0===u.receiver.receiverId&&t>0&&(u.receiver.receiverId=o[0].SysNo,u.receiver.phone=o[0].ReceiverMobile,u.receiver.receiver=o[0].ReceiverName,u.receiver.pcdDes=o[0].Province+" "+o[0].City+" "+o[0].District+" "+o[0].Street,u.receiver.address=o[0].Address)}}),e("/cart/cart-info",{},function(r,o){if(r)$.toast(r,1e3);else{for(var t=o.cart,i=t.length,a=null,c={},n=0;i>n;n++)if(a=t[n],-1!==d.indexOf(a.ProductSysNo+"")){var s={};u.promotion+=a.PromotionAmount,void 0===c[a.ProductSysNo]?(c[a.ProductSysNo]={},c[a.ProductSysNo].name=a.Name,c[a.ProductSysNo].productId=a.ProductSysNo,c[a.ProductSysNo].image=a.Images.length>0?a.Images[0].ImgUrl:"",c[a.ProductSysNo].skus=[],c[a.ProductSysNo].checked=!0,c[a.ProductSysNo].stock=a.Stock,s.cartId=a.SysId,s.skuId=a.SkuSysNo,s.size=a.SizeName,s.qty=a.Qty,s.price=a.Price,u.countPrice+=s.price*s.qty,c[a.ProductSysNo].skus.push(s),u.cartIds.push(s.cartId)):(s.cartId=a.SysId,s.skuId=a.SkuSysNo,s.size=a.SizeName,s.qty=a.Qty,s.price=a.Price,u.countPrice+=s.price*s.qty,c[a.ProductSysNo].skus.push(s),u.cartIds.push(s.cartId))}for(var l in c)c.hasOwnProperty(l)&&u.cartsAry.push(c[l]);e("/cart/user-promotion",{cartIds:JSON.stringify(u.cartIds)},function(e,r){$.hidePreloader(),e?$.toast(e,1e3):(u.promotion+=r.promotion,u.promotion=u.promotion.toFixed(2))})}}),$.showPreloader("请稍等..."),$(a).on("click","#submitBook",function(r){r.preventDefault(),e("/book/confirm",{receiverId:u.receiver.receiverId,logistics:"快递",payment:u.payment,cartIds:JSON.stringify(u.cartIds)},function(r,o){if($.hidePreloader(),r)$.toast(r,1e3);else{var t=o.orderId;e("/book/detail",{orderId:t},function(r,i){if($.hidePreloader(),r)$.toast(r,1e3);else{var a=i.order;if(0===a.Amount)e("/book/create-pay-record",{orderId:t},function(e,r){return e?void $.toast(e,1e3):(window.history.replaceState({cart:1},"","/users/my-book"),void(location.href="/users/my-book"))});else{if(window.history.replaceState({cart:1},"","/users/my-book"),0===u.payment)return void(location.href="/weixin/oauth?orderId="+o.orderId+"&name="+u.receiver.receiver);if(4===u.payment)return window.history.replaceState({cart:1},"","/users/my-book"),void(location.href="/book/complete")}}}),$.showPreloader("准备支付...")}}),$.showPreloader("提交订单...")})}),$(document).on("pageInit","#page-book-complete",function(e,o,t){new r({el:"#page-book-complete",data:{}})}),$(document).on("pageInit","#page-book-pay-way",function(t,i,a){function c(){e("/book/detail",{orderId:l},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var o=r.order;f.amount=100*o.Amount,f.isReady=!0}})}function n(e){WeixinJSBridge.invoke("getBrandWCPayRequest",e,function(e){"get_brand_wcpay_request:ok"==e.err_msg?location.href="/book/complete":($.toast("支付失败, 请到我的订单重新支付！",1e3),setTimeout(function(){location.href="/users/my-book"},1e3))})}function s(){e("/weixin/pay",{openId:u,orderId:l,amount:f.amount,userName:p},function(e,r){$.hidePreloader(),e?$.toast(e,1e3):n(r.payargs)})}var d=o.getSearch(location),u=0,l=0,p="";d.openId&&d.state||(location.href="/"),u=d.openId;var v=d.state;v=v.split("@"),l=parseInt(v[0]),p=v[1];var f=new r({el:"#page-book-pay-way",data:{amount:0,isReady:!1},methods:{pay:s}});c(),$.showPreloader("请稍等...")}),$(document).on("pageInit","#page-book-detail",function(t,i,a){function c(){location.href="/weixin/oauth?orderId="+u+"&name="+l.order.ReceiverName,$.showPreloader("准备支付...")}function n(){$.confirm("确定取消该订单吗?",function(){e("/book/cancel",{orderId:l.orderId},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var o=l.order;o.Status="已取消",o.statusNote="已取消",o.canCancel=!1,o.canPay=!1,o.reBuy=!0}}),$.showPreloader("取消订单")},function(){})}function s(){}var d=o.getSearch(location);if(!d.id)return void(location.href="/");var u=parseInt(d.id),l=new r({el:"#page-book-detail",data:{orderId:u,order:{}},methods:{payOrder:c,cancelOrder:n,reBuy:s}});e("/book/detail",{orderId:l.orderId},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var t=r.order;t.statusNote="",t.canCancel=!1,t.canPay=!1,t.reBuy=!1,t.PCD=t.PCD.replace(/\-/g," "),"待审核"===t.Status||"待付款"===t.Status?"货到付款"!==t.PayMent&&"UnPay"===t.PayStatus?(t.statusNote="待付款",t.canCancel=!0,t.canPay=!0):(t.statusNote="待审核",t.canCancel=!0):"待发货"===t.Status||"已发货"===t.Status?t.statusNote=t.Status:(t.statusNote=t.Status,t.reBuy=!0),l.order=o.clone(t)}}),$.showPreloader("请稍等")}),$.init()})}();