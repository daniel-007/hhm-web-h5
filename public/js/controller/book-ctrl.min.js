!function(){function e(e,r,t){$.ajax({type:"POST",url:e,data:r,timeout:15e3,success:function(e,r,o){e.status?t(null,e):t(e.msg,null)},error:function(r,o,i){console.error(e+" error: "+o+"##"+i),t("服务异常",null)}})}require.config({baseUrl:"../js",paths:{Vue:"./lib/vue.min",Utils:"./lib/utils"},shim:{Vue:{exports:"Vue"},Utils:{exports:"Utils"}}}),require(["Vue","Utils"],function(r,t){"use strict";r.config.delimiters=["${","}"],r.config.unsafeDelimiters=["{!!","!!}"],$(document).on("pageInit","#page-book-confirm",function(o,i,c){var s=t.getSearch(location),n=0;s.id&&(n=parseInt(s.id));var a=new r({el:"#page-book-confirm",data:{payment:1,receiver:null,cartsAry:[],countPrice:0,cartIds:[]}});e("/address/get-all-receiver",{},function(e,r){if(e)$.toast(e,1e3);else{var t=r.receiver,o=t.length,i=0;if(n>0){for(i=0;o>i;i++)if(t[i].SysNo===n){a.receiver={},a.receiver.receiverId=t[i].SysNo,a.receiver.phone=t[i].ReceiverPhone,a.receiver.receiver=t[i].ReceiverName,a.receiver.pcdDes=t[i].Province+" "+t[i].City+" "+t[i].District,a.receiver.address=t[i].Address;break}}else for(i=0;o>i;i++)if(t[i].IsDefault){a.receiver={},a.receiver.receiverId=t[i].SysNo,a.receiver.phone=t[i].ReceiverPhone,a.receiver.receiver=t[i].ReceiverName,a.receiver.pcdDes=t[i].Province+" "+t[i].City+" "+t[i].District,a.receiver.address=t[i].Address;break}null===a.receiver&&o>0&&(a.receiver={},a.receiver.receiverId=t[0].SysNo,a.receiver.phone=t[0].ReceiverPhone,a.receiver.receiver=t[0].ReceiverName,a.receiver.pcdDes=t[0].Province+" "+t[0].City+" "+t[0].District,a.receiver.address=t[0].Address)}}),e("/cart/cart-info",{},function(e,r){if(e)$.toast(e,1e3);else{for(var t=r.cart,o=t.length,i=null,c={},s=0;o>s;s++){i=t[s];var n={};void 0===c[i.ProductSysNo]?(c[i.ProductSysNo]={},c[i.ProductSysNo].name=i.Name,c[i.ProductSysNo].productId=i.ProductSysNo,c[i.ProductSysNo].image=i.Images.length>0?i.Images[0].ImgUrl:"",c[i.ProductSysNo].skus=[],c[i.ProductSysNo].checked=!0,c[i.ProductSysNo].stock=i.Stock,n.cartId=i.SysId,n.skuId=i.SkuSysNo,n.size=i.SizeName,n.qty=i.Qty,n.price=i.Price,a.countPrice+=n.price*n.qty,c[i.ProductSysNo].skus.push(n),a.cartIds.push(n.cartId)):(n.cartId=i.SysId,n.skuId=i.SkuSysNo,n.size=i.SizeName,n.qty=i.Qty,n.price=i.Price,a.countPrice+=n.price*n.qty,c[i.ProductSysNo].skus.push(n),a.cartIds.push(n.cartId))}for(var d in c)c.hasOwnProperty(d)&&a.cartsAry.push(c[d])}}),$(c).on("click","#submitBook",function(r){r.preventDefault(),e("/book/confirm",{receiverId:a.receiver.receiverId,logistics:"快递",payment:a.payment,cartIds:JSON.stringify(a.cartIds)},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{if(1===a.payment)return location.href="/weixin/oauth?orderId="+r.orderId+"&name="+a.receiver.receiver,void $.showPreloader("准备支付...");if(2===a.payment)return void(location.href="/book/complete")}}),$.showPreloader("提交订单...")})}),$(document).on("pageInit","#page-book-complete",function(e,t,o){new r({el:"#page-book-complete",data:{}})}),$(document).on("pageInit","#page-book-pay-way",function(o,i,c){function s(){e("/book/detail",{orderId:p},function(e,r){if($.hidePreloader(),e)$.toast(e,1e3);else{var t=r.order;v.amount=100*t.Amount,v.isReady=!0}})}function n(e){WeixinJSBridge.invoke("getBrandWCPayRequest",e,function(e){alert(JSON.stringify(e)),"get_brand_wcpay_request:ok"==e.err_msg?location.href="/book/complete":($.toast("支付失败, 请到我的订单重新支付！",1e3),setTimeout(function(){location.href="/users/my-book"},1e3))})}function a(){e("/weixin/pay",{openId:u,orderId:p,amount:v.amount,userName:l},function(e,r){$.hidePreloader(),e?$.toast(e,1e3):n(r.payargs)})}var d=t.getSearch(location),u=0,p=0,l="";d.openId&&d.state||(location.href="/"),u=d.openId;var y=d.state.split("@").orderId=parseInt(y[0]);l=y[1];var v=new r({el:"#page-book-pay-way",data:{amount:0,isReady:!1},methods:{pay:a}});s(),$.showPreloader("请稍等...")}),$(document).on("pageInit","#page-book-detail",function(e,o,i){var c=t.getSearch(location);new r({el:"#page-book-detail",data:{type:parseInt(c.status)},computed:{bookStatus:function(){return 1===this.type?"待付款":2===this.type?"待审核":3===this.type?"已完成":4===this.type?"已取消":5===this.type?"已发货":6===this.type?"待发货":void 0},isNeedPay:function(){return 1===this.type},operateName:function(){return 1===this.type||2===this.type?"取消订单":3===this.type||4===this.type||5===this.type?"再次购买":void 0},isOperate:function(){return 6!==this.type}}})}),$.init()})}();